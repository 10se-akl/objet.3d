<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Objets 3D ‚Äî Axel & Noah</title>

<!-- PayPal SDK : remplacez YOUR_PAYPAL_CLIENT_ID par votre client-id r√©el si n√©cessaire -->
<script src="https://www.paypal.com/sdk/js?client-id=YOUR_PAYPAL_CLIENT_ID&currency=EUR" defer></script>

<style>
  :root{
    --accent:#ff6600;
    --bg:#fafafa;
    --card:#ffffff;
    --dark:#222;
    --muted:#666;
    --maxw:1100px;
    --glass: rgba(255,255,255,0.6);
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    font-family:Inter, "Segoe UI", Roboto, Arial, sans-serif;
    background:linear-gradient(180deg,#fbfbfb 0%, #f4f5f7 100%);
    color:#111;
    -webkit-font-smoothing:antialiased;
    -moz-osx-font-smoothing:grayscale;
    line-height:1.4;
  }

  /* Header */
  header{
    position:fixed;
    top:0; left:0; right:0;
    height:68px;
    background:linear-gradient(180deg,#0f0f0f 0%, #1a1a1a 100%);
    color:white;
    display:flex;
    align-items:center;
    justify-content:space-between;
    padding:0 18px;
    z-index:2000;
    box-shadow:0 6px 24px rgba(0,0,0,0.18);
  }
  .brand{ display:flex; gap:12px; align-items:center; }
  .logo{ width:48px; height:48px; border-radius:10px; background:var(--accent); display:flex; align-items:center; justify-content:center; font-weight:800; color:white; font-size:16px; }
  header h1{ margin:0; font-size:18px; letter-spacing:0.2px; font-weight:700; color:#fff; }
  nav.main{ display:flex; gap:10px; align-items:center; }

  button.icon-btn{
    background:transparent; border:none; color:white; cursor:pointer; font-size:15px;
    padding:8px 10px; border-radius:8px;
  }
  button.icon-btn:hover{ background:rgba(255,255,255,0.04) }

  /* Main container */
  main{ padding-top:92px; max-width:var(--maxw); margin:24px auto; padding-left:18px; padding-right:18px; }

  /* Hero */
  .hero{
    display:flex; gap:18px; align-items:center; justify-content:space-between;
    background: linear-gradient(90deg,#ffffff 0%, #fffaf0 100%);
    padding:22px; border-radius:12px; box-shadow:0 6px 30px rgba(0,0,0,0.05);
  }
  .hero .left h2{ margin:0 0 8px 0; color:var(--dark); }
  .hero .left p{ margin:0; color:var(--muted) }

  /* Grid */
  .grid{
    margin-top:20px;
    display:grid;
    grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
    gap:18px;
  }
  .card{
    background:var(--card);
    border-radius:12px;
    padding:14px;
    box-shadow:0 6px 18px rgba(0,0,0,0.06);
    display:flex; flex-direction:column; gap:10px;
  }
  .card img{ width:100%; height:160px; object-fit:cover; border-radius:8px; }
  .card h3{ margin:0; font-size:16px; color:var(--dark) }
  .card p{ margin:0; color:var(--muted); font-size:14px; min-height:40px; }
  .meta{ display:flex; align-items:center; justify-content:space-between; gap:8px; margin-top:6px }
  .price{ font-weight:700; color:var(--accent) }

  /* Product view */
  .product-view{ margin-top:18px; display:none; }
  .pv-wrap{ display:flex; gap:18px; align-items:flex-start; }
  .pv-gallery{ width:480px; }
  .pv-main{ width:100%; height:420px; border-radius:10px; overflow:hidden; background:#eee; display:flex; align-items:center; justify-content:center; }
  .pv-main img{ width:100%; height:100%; object-fit:cover; }
  .pv-thumbs{ display:flex; gap:8px; margin-top:10px; flex-wrap:wrap; }
  .pv-thumbs img{ height:64px; width:88px; object-fit:cover; border-radius:6px; cursor:pointer; opacity:.85; border:2px solid transparent }
  .pv-thumbs img.active{ opacity:1; border-color:var(--accent) }

  .pv-info{ flex:1; background:var(--card); padding:16px; border-radius:12px; box-shadow:0 6px 18px rgba(0,0,0,0.04); }
  .pv-info h2{ margin:0 0 8px 0; }
  .pv-info .muted{ color:var(--muted); font-size:14px; margin-bottom:10px; }

  .qty-row{ margin-top:12px; display:flex; gap:10px; align-items:center; }
  input[type="number"]{ padding:8px 10px; border-radius:8px; border:1px solid #ddd; width:100px; }

  .btn-primary{ background:var(--accent); color:white; border:none; padding:12px 16px; border-radius:8px; cursor:pointer; font-weight:700 }
  .btn-ghost{ background:#f5f5f5; border:1px solid #eee; padding:10px; border-radius:8px; cursor:pointer }

  /* Cart table */
  .cart-wrap{ margin-top:18px; display:none; }
  table.cart{ width:100%; border-collapse:collapse; background:var(--card); border-radius:12px; overflow:hidden; box-shadow:0 6px 18px rgba(0,0,0,0.06) }
  table.cart th, table.cart td{ padding:12px 14px; text-align:left; border-bottom:1px solid #f0f0f0; font-size:14px }
  table.cart thead{ background:#fafafa }

  /* Form */
  .form-wrap{ margin-top:18px; display:none; }
  form.card-form{ display:flex; flex-direction:column; gap:10px; }

  /* Modal */
  .modal-backdrop{ position:fixed; inset:0; display:flex; align-items:center; justify-content:center; background:rgba(0,0,0,0.45); z-index:3000 }
  .modal{ width:100%; max-width:520px; background:white; padding:18px; border-radius:12px; box-shadow:0 12px 40px rgba(0,0,0,0.25) }

  /* Footer */
  footer.site-footer{ margin-top:28px; background:#0f0f0f; color:#ddd; padding:12px 16px; border-radius:10px; max-width:var(--maxw); margin-left:auto; margin-right:auto; display:flex; justify-content:space-between; align-items:center; gap:12px; }
  @media (max-width:980px){
    .pv-wrap{ flex-direction:column }
    .pv-gallery{ width:100% }
    header{ padding:0 12px }
    main{ padding-left:12px; padding-right:12px }
    .grid{ grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); }
  }
</style>
</head>
<body>

<header>
  <div class="brand">
    <div class="logo">3D</div>
    <div>
      <h1>Objets 3D ‚Äî Axel & Noah</h1>
      <div style="font-size:12px;color:#e6e6e6">Impression & cr√©ation locale</div>
    </div>
  </div>

  <nav class="main" aria-label="Navigation principale">
    <button class="icon-btn" id="btnAccueil">Accueil</button>
    <button class="icon-btn" id="btnBoutique">Boutique</button>
    <button class="icon-btn" id="btnPanier">üõí Panier <span id="cartCount">0</span></button>

    <div id="authArea" style="display:flex; align-items:center; gap:8px; margin-left:12px">
      <div id="notLogged" style="display:flex; gap:8px">
        <button class="icon-btn" id="openLogin">Connexion</button>
        <button class="icon-btn" id="openRegister">Inscription</button>
      </div>
      <div id="logged" style="display:none; align-items:center; gap:8px">
        <div class="user-bubble" id="userBadge" style="background:rgba(255,255,255,0.06); padding:6px 10px; border-radius:8px; color:#fff">Utilisateur</div>
        <button class="icon-btn" id="logoutBtn">D√©connexion</button>
      </div>
    </div>
  </nav>
</header>

<main>
  <!-- HERO / Accueil -->
  <section id="sectionAccueil">
    <div class="hero">
      <div class="left">
        <h2>Objets 3D faits main ‚Äî Petite boutique</h2>
        <p>Produits imprim√©s localement, personnalisables. Paiement PayPal / CB (simulation) / √† la livraison.</p>
      </div>
      <div style="display:flex; gap:12px; align-items:center">
        <div style="text-align:right;">
          <div style="font-size:12px;color:var(--muted)">Connect√© en tant que :</div>
          <div id="userStatus" style="font-weight:700;color:var(--accent)">Invit√©</div>
        </div>
        <div style="background:#fff; padding:8px 12px; border-radius:8px; box-shadow:0 6px 18px rgba(0,0,0,0.06)">
          <div style="font-size:13px; color:var(--muted)">Panier</div>
          <div style="font-weight:700; font-size:18px" id="cartCountLarge">0</div>
        </div>
      </div>
    </div>
  </section>

  <!-- BOUTIQUE: liste de produits -->
  <section id="sectionBoutique" style="margin-top:18px; display:none;">
    <h3>Nos produits</h3>
    <div class="grid" id="productsGrid"></div>
  </section>

  <!-- VUE PRODUIT -->
  <section id="sectionProductView" class="product-view">
    <div class="pv-wrap">
      <div class="pv-gallery card pv-gallery">
        <div class="pv-main" id="pvMain"><img id="pvMainImg" src="" alt="Image produit"></div>
        <div class="pv-thumbs" id="pvThumbs"></div>
      </div>

      <div class="pv-info">
        <h2 id="pvTitle">Titre</h2>
        <div class="muted" id="pvDesc">Description</div>
        <div style="margin-top:10px; display:flex; gap:10px; align-items:center;">
          <div style="font-size:18px; font-weight:700" id="pvPrice">‚Ç¨0.00</div>
          <div style="color:var(--muted); font-size:13px" id="pvStock">Stock : ‚Äî</div>
        </div>

        <div style="margin-top:12px" id="pvTech">D√©tails techniques</div>

        <div class="qty-row">
          <label for="pvQuantity">Quantit√©</label>
          <input type="number" id="pvQuantity" min="1" value="1" />
        </div>

        <div style="margin-top:12px; display:flex; gap:10px">
          <button class="btn-primary" id="pvAddBtn">Ajouter au panier</button>
          <button class="btn-ghost" id="pvOrderBtn">Commander</button>
        </div>
      </div>
    </div>
  </section>

  <!-- PANIER -->
  <section id="sectionCart" class="cart-wrap" style="display:none;">
    <h3>Panier</h3>
    <div style="overflow:auto;">
      <table class="cart" aria-live="polite">
        <thead>
          <tr><th>Produit</th><th>Quantit√©</th><th>Prix</th><th>Actions</th></tr>
        </thead>
        <tbody id="cartTable"></tbody>
      </table>
    </div>

    <div style="display:flex; justify-content:space-between; margin-top:12px; align-items:center">
      <div>
        <button class="btn-ghost" id="btnClearCart">Vider le panier</button>
      </div>
      <div style="text-align:right">
        <div class="small-muted">Total :</div>
        <div style="font-weight:700; font-size:18px" id="cartTotal">‚Ç¨0.00</div>
        <div style="margin-top:8px">
          <button class="btn-primary" id="btnCheckoutCart">Commander le panier</button>
        </div>
      </div>
    </div>
  </section>

  <!-- FORMULAIRE COMMANDE -->
  <section id="sectionForm" class="form-wrap" style="display:none;">
    <h3>Commander</h3>
    <div class="card">
      <form id="orderForm" class="card-form">
        <div style="display:flex; gap:8px; flex-wrap:wrap;">
          <div style="flex:1; min-width:150px">
            <label for="inputNom">Nom</label>
            <input id="inputNom" name="nom" type="text" required />
          </div>
          <div style="flex:1; min-width:150px">
            <label for="inputPrenom">Pr√©nom</label>
            <input id="inputPrenom" name="prenom" type="text" required />
          </div>
        </div>

        <div>
          <label for="inputAdresse">Adresse</label>
          <input id="inputAdresse" name="adresse" type="text" required />
        </div>

        <div style="display:flex; gap:8px">
          <div style="flex:1">
            <label for="inputCode">Code postal</label>
            <input id="inputCode" name="codepostal" type="text" pattern="[0-9]{5}" />
          </div>
          <div style="flex:1">
            <label for="inputEmail">Email</label>
            <input id="inputEmail" name="email" type="email" required />
          </div>
        </div>

        <div>
          <label for="inputQuantityTotal">Quantit√© totale</label>
          <input id="inputQuantityTotal" name="quantite" type="number" min="1" value="1" />
        </div>

        <div>
          <label for="selectPayment">Moyen de paiement</label>
          <select id="selectPayment" name="moyenPaiement" onchange="onPaymentChange()" required>
            <option value="">-- Choisir --</option>
            <option value="paypal">PayPal</option>
            <option value="paypalme">PayPal.me</option>
            <option value="virement">Virement bancaire</option>
            <option value="cb_simule">Carte bancaire (simulation)</option>
            <option value="cash">Paiement √† la livraison</option>
          </select>
        </div>

        <div id="paypalButtonContainer" style="margin-top:8px; display:none"></div>

        <input type="hidden" id="hiddenObjet" name="objet" />
        <input type="hidden" id="hiddenPaymentStatus" name="payment_status" value="pending" />

        <div style="display:flex; gap:8px; margin-top:8px">
          <button class="btn-primary" type="submit" id="btnSubmitOrder">Envoyer la commande</button>
          <button type="button" class="btn-ghost" id="btnCancelOrder">Annuler</button>
        </div>

        <p class="muted-note">Remarque : la CB est simul√©e ici. Pour paiements r√©els, int√©grer Stripe (backend requis).</p>
      </form>
    </div>
  </section>

  <!-- Modal container -->
  <div id="modalContainer" aria-hidden="true"></div>

</main>

<footer class="site-footer" role="contentinfo">
  <div class="footer-left">
    <strong>Contact rapide</strong><br>
    <span class="small-muted">objet.3d.axel.et.noah@gmail.com</span>
  </div>
  <div class="footer-contact">
    <div><strong>Quand vous √™tes connect√© :</strong></div>
    <ul>
      <li>Voir le panier et commander le panier</li>
      <li>Enregistrer vos moyens de paiement</li>
      <li>Recevoir des notifications par e-mail</li>
    </ul>
  </div>
</footer>

<script>
/* ===========================
   DONN√âES PRODUITS
   =========================== */
const PRODUCTS = [
  {
    id: 'objet1',
    titre: 'Porte-stylo √âco',
    description: 'Porte-stylo √©l√©gant imprim√© en PLA recycl√©. Dimensions : 8x8x10 cm.',
    images: [
      'https://via.placeholder.com/1200x900?text=Porte-stylo+1',
      'https://via.placeholder.com/1200x900?text=Porte-stylo+2'
    ],
    fabrication: 'Marcoussis, France',
    prix: 9.90,
    stock: 12,
    tech: 'PLA recycl√© ‚Ä¢ 0.2mm layer'
  },
  {
    id: 'objet2',
    titre: 'Support Smartphone',
    description: 'Support pour smartphone compatible grand format.',
    images: [
      'https://via.placeholder.com/1200x900?text=Support+1',
      'https://via.placeholder.com/1200x900?text=Support+2'
    ],
    fabrication: 'Marcoussis, France',
    prix: 12.50,
    stock: 6,
    tech: 'PLA+ ‚Ä¢ 0.16mm layer'
  },
  {
    id: 'objet3',
    titre: 'D√©coration Personnalis√©e',
    description: 'D√©coration personnalisable ‚Äî envoi avec emballage soign√©.',
    images: [
      'https://via.placeholder.com/1200x900?text=Deco+1',
      'https://via.placeholder.com/1200x900?text=Deco+2',
      'https://via.placeholder.com/1200x900?text=Deco+3'
    ],
    fabrication: 'Marcoussis, France',
    prix: 18.00,
    stock: 4,
    tech: 'PLA + finitions peinture'
  }
];

/* ===========================
   STATE & UTILITAIRES
   =========================== */
let cart = JSON.parse(localStorage.getItem('cart_v1')) || []; // [{id, titre, prix, quantite}]
let paypalRendered = false;
let currentProductId = null;

/* Helper: escape HTML */
function escapeHtml(s){
  if(!s) return '';
  return String(s).replace(/[&<>"']/g, function(m){ return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[m]; });
}

/* Save cart */
function saveCart(){ localStorage.setItem('cart_v1', JSON.stringify(cart)); }

/* ===========================
   RENDER PRODUITS
   =========================== */
function renderProducts(){
  const grid = document.getElementById('productsGrid');
  grid.innerHTML = '';
  PRODUCTS.forEach(p => {
    const div = document.createElement('div');
    div.className = 'card';
    div.innerHTML = `
      <img src="${escapeHtml(p.images[0])}" alt="${escapeHtml(p.titre)}">
      <h3>${escapeHtml(p.titre)}</h3>
      <p>${escapeHtml(p.description)}</p>
      <div class="meta">
        <div class="price">‚Ç¨${p.prix.toFixed(2)}</div>
        <div style="display:flex; gap:8px">
          <button class="btn-ghost" data-action="view" data-id="${p.id}">Voir</button>
          <button class="btn-primary" data-action="add" data-id="${p.id}">Ajouter</button>
        </div>
      </div>
    `;
    grid.appendChild(div);
  });
}

/* ===========================
   NAVIGATION / AFFICHAGE
   =========================== */
const sections = {
  accueil: document.getElementById('sectionAccueil'),
  boutique: document.getElementById('sectionBoutique'),
  product: document.getElementById('sectionProductView'),
  cart: document.getElementById('sectionCart'),
  form: document.getElementById('sectionForm')
};

function showSection(name){
  // hide all
  Object.values(sections).forEach(s => s.style.display = 'none');
  // show requested
  if(name === 'accueil') sections.accueil.style.display = 'block';
  else if(name === 'boutique') sections.boutique.style.display = 'block';
  else if(name === 'product') sections.product.style.display = 'block';
  else if(name === 'cart') sections.cart.style.display = 'block';
  else if(name === 'form') sections.form.style.display = 'block';
  window.scrollTo({top:0, behavior:'smooth'});
}

/* ===========================
   VIEW PRODUIT (DETAIL)
   =========================== */
function openProduct(productId){
  const p = PRODUCTS.find(x => x.id === productId);
  if(!p) return alert('Produit introuvable.');
  currentProductId = productId;

  document.getElementById('pvMainImg').src = p.images[0];
  document.getElementById('pvTitle').textContent = p.titre;
  document.getElementById('pvDesc').textContent = p.description;
  document.getElementById('pvPrice').textContent = '‚Ç¨' + p.prix.toFixed(2);
  document.getElementById('pvStock').textContent = 'Stock : ' + p.stock;
  document.getElementById('pvTech').textContent = p.tech;
  document.getElementById('pvQuantity').value = 1;

  // thumbs
  const thumbs = document.getElementById('pvThumbs');
  thumbs.innerHTML = '';
  p.images.forEach((src, idx) => {
    const img = document.createElement('img');
    img.src = src;
    if(idx === 0) img.classList.add('active');
    img.addEventListener('click', () => {
      document.querySelectorAll('#pvThumbs img').forEach(i => i.classList.remove('active'));
      img.classList.add('active');
      document.getElementById('pvMainImg').src = src;
    });
    thumbs.appendChild(img);
  });

  // attach add + order
  document.getElementById('pvAddBtn').onclick = () => {
    const q = parseInt(document.getElementById('pvQuantity').value || 1, 10);
    addToCart(productId, q);
  };
  document.getElementById('pvOrderBtn').onclick = () => {
    openFormFor(productId);
  };

  showSection('product');
}

/* ===========================
   PANIER (cart) FUNCTIONS
   =========================== */
function addToCart(productId, quantity = 1){
  const p = PRODUCTS.find(x => x.id === productId);
  if(!p) return alert('Produit introuvable.');
  quantity = Number(quantity) || 1;
  if(quantity < 1) return alert('Quantit√© invalide.');
  if(quantity > p.stock) return alert('Quantit√© demand√©e sup√©rieure au stock disponible.');

  const existing = cart.find(it => it.id === productId);
  if(existing){
    if(existing.quantite + quantity > p.stock) return alert('Trop de quantit√© (stock d√©pass√©).');
    existing.quantite += quantity;
  } else {
    cart.push({ id: p.id, titre: p.titre, prix: p.prix, quantite: quantity });
  }
  saveCart();
  updateCartUI();
  alert(`${p.titre} ajout√© au panier`);
}

function removeFromCart(index){
  if(index < 0 || index >= cart.length) return;
  if(!confirm(`Supprimer ${cart[index].titre} du panier ?`)) return;
  cart.splice(index,1);
  saveCart();
  renderCartTable();
}

function changeQty(index, delta){
  if(index < 0 || index >= cart.length) return;
  const item = cart[index];
  const p = PRODUCTS.find(x => x.id === item.id);
  item.quantite += delta;
  if(item.quantite <= 0) {
    cart.splice(index,1);
  } else {
    if(item.quantite > p.stock){
      alert('Stock insuffisant');
      item.quantite = p.stock;
    }
  }
  saveCart();
  renderCartTable();
}

function calculateCartTotal(){
  return cart.reduce((s,i)=> s + (i.prix || 0) * i.quantite, 0);
}

/* Renders */
function updateCartUI(){
  const totalQty = cart.reduce((s,i)=> s + i.quantite, 0);
  document.getElementById('cartCount').textContent = totalQty;
  document.getElementById('cartCountLarge').textContent = totalQty;
  renderCartTable(); // also updates total & visibility
}

function renderCartTable(){
  const tbody = document.getElementById('cartTable');
  tbody.innerHTML = '';
  if(cart.length === 0){
    const tr = document.createElement('tr');
    tr.innerHTML = '<td colspan="4">Votre panier est vide.</td>';
    tbody.appendChild(tr);
    document.getElementById('cartTotal').textContent = '‚Ç¨0.00';
    document.getElementById('btnCheckoutCart').disabled = true;
    return;
  }
  cart.forEach((it, idx) => {
    const tr = document.createElement('tr');
    const totalPrice = (it.prix * it.quantite).toFixed(2);
    tr.innerHTML = `
      <td>${escapeHtml(it.titre)}</td>
      <td>${it.quantite}</td>
      <td>‚Ç¨${totalPrice}</td>
      <td>
        <button class="btn-ghost" data-action="dec" data-idx="${idx}">-</button>
        <button class="btn-ghost" data-action="inc" data-idx="${idx}">+</button>
        <button class="btn-ghost" data-action="rm" data-idx="${idx}">Supprimer</button>
      </td>
    `;
    tbody.appendChild(tr);
  });
  document.getElementById('cartTotal').textContent = '‚Ç¨' + calculateCartTotal().toFixed(2);
  document.getElementById('btnCheckoutCart').disabled = false;
}

/* Clear cart */
function clearCart(){
  if(!confirm('Vider compl√®tement le panier ?')) return;
  cart = [];
  saveCart();
  updateCartUI();
}

/* ===========================
   COMMANDE / FORMULAIRE
   =========================== */
function openFormFor(productIdOrCart){
  // prefill user data if logged
  const user = getCurrentUser();
  if(user){
    document.getElementById('inputNom').value = user.nom || '';
    document.getElementById('inputPrenom').value = user.prenom || '';
    document.getElementById('inputEmail').value = user.email || '';
  }

  if(productIdOrCart === 'cart' || productIdOrCart === 'panier'){
    const texte = cart.map(p => `${p.titre} x ${p.quantite}`).join(' ; ');
    document.getElementById('hiddenObjet').value = texte || 'Panier';
    document.getElementById('inputQuantityTotal').value = cart.reduce((s,i)=>s+i.quantite,0) || 1;
  } else {
    const p = PRODUCTS.find(x => x.id === productIdOrCart);
    if(p){
      document.getElementById('hiddenObjet').value = p.titre;
      document.getElementById('inputQuantityTotal').value = document.getElementById('pvQuantity') ? document.getElementById('pvQuantity').value : 1;
    }
  }
  showSection('form');
}

/* Payment selector */
function onPaymentChange(){
  const val = document.getElementById('selectPayment').value;
  const container = document.getElementById('paypalButtonContainer');
  container.style.display = 'none';
  if(val === 'paypal'){
    container.style.display = 'block';
    renderPaypalButton();
  } else if(val === 'paypalme'){
    container.style.display = 'none';
    // open paypal.me when submitted; we prefer to open after submit (not here)
  } else if(val === 'virement'){
    alert('Virement bancaire :\nIBAN: FR76 XXXX XXXX XXXX XXXX XXXX\nBIC: XXXXXX\nTitulaire: Axel & Noah');
  } else if(val === 'cb_simule'){
    // We'll open modal simulation when user submits
  }
}

/* PayPal render */
function renderPaypalButton(){
  // checks
  if(typeof paypal === 'undefined'){
    console.warn('PayPal SDK non charg√© (v√©rifiez client id).');
    return;
  }
  if(paypalRendered) return;
  paypalRendered = true;
  paypal.Buttons({
    style: { layout:'vertical', color:'gold', shape:'rect', label:'paypal' },
    createOrder: function(data, actions){
      const total = calculateCartTotal();
      return actions.order.create({
        purchase_units: [{ amount: { value: total.toFixed(2) } }]
      });
    },
    onApprove: function(data, actions){
      return actions.order.capture().then(function(details){
        document.getElementById('hiddenPaymentStatus').value = 'paid_paypal';
        submitOrder({ paymentProvider: 'paypal', paymentDetails: details });
      });
    },
    onError: function(err){
      alert('Erreur PayPal : ' + (err && err.message ? err.message : 'Erreur'));
    }
  }).render('#paypalButtonContainer');
}

/* Submit order (fake send to Web3Forms) */
function submitOrder(extra = {}){
  const form = document.getElementById('orderForm');
  const fd = new FormData(form);
  const objet = fd.get('objet') || '';
  const paymentMethod = fd.get('moyenPaiement') || extra.paymentProvider || 'inconnu';
  const currentUser = getCurrentUser();

  const message = `Commande: ${objet}
Nom: ${fd.get('nom')}
Pr√©nom: ${fd.get('prenom')}
Adresse: ${fd.get('adresse')}
Code Postal: ${fd.get('codepostal')}
Email: ${fd.get('email')}
Quantit√©: ${fd.get('quantite')}
Moyen de paiement: ${paymentMethod}
Utilisateur connect√©: ${currentUser ? currentUser.email : 'aucun'}`;

  const payload = {
    access_key: "867b9f7b-a375-47c5-a0c0-ec184b69f529",
    subject: `Nouvelle commande : ${objet}`,
    sender_name: fd.get('prenom') + ' ' + fd.get('nom'),
    sender_email: fd.get('email'),
    message: message,
    data: Object.fromEntries(fd.entries())
  };
  if(extra.paymentDetails) payload.payment_details = extra.paymentDetails;

  // Fake send (we use real endpoint in original; here we simulate success for demo)
  fetch('https://api.web3forms.com/submit', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(payload)
  })
  .then(res => res.json())
  .then(json => {
    if(json && json.success){
      alert('Commande re√ßue ‚Äî merci !');
      // vider panier si c'√©tait une commande panier
      const objField = objet || '';
      if(objField.includes(' x ') || objField.includes(';') || objField.toLowerCase().includes('panier')){
        cart = [];
        saveCart();
      }
      form.reset();
      document.getElementById('hiddenPaymentStatus').value = 'pending';
      updateCartUI();
      showSection('accueil');
    } else {
      // si l'API renvoie erreur (ou cl√© invalide), on affiche message d'erreur pour debug
      alert('Erreur lors de l\'envoi de la commande. V√©rifiez la configuration (cl√© access_key).');
      console.error('web3forms error', json);
    }
  })
  .catch(err => {
    console.error(err);
    alert('Erreur r√©seau lors de l\'envoi de la commande.');
  });
}

/* Order form submit handler */
document.getElementById('orderForm').addEventListener('submit', function(e){
  e.preventDefault();
  const fd = new FormData(e.target);
  const moyen = fd.get('moyenPaiement');

  if(!moyen){
    alert('Veuillez choisir un moyen de paiement.');
    return;
  }

  if(moyen === 'paypal'){
    // force user to click PayPal button ‚Äî ensure paymentStatus was set by PayPal
    if(document.getElementById('hiddenPaymentStatus').value === 'paid_paypal'){
      submitOrder({ paymentProvider: 'paypal' });
    } else {
      alert('Veuillez finaliser le paiement PayPal via le bouton PayPal (ou changez de moyen).');
    }
    return;
  } else if(moyen === 'paypalme'){
    // open paypal.me link and consider pending (client must pay manually)
    window.open('https://paypal.me/objet_3d_a_et_n', '_blank');
    document.getElementById('hiddenPaymentStatus').value = 'pending_paypalme';
    submitOrder({ paymentProvider: 'paypalme' });
    return;
  } else if(moyen === 'virement'){
    document.getElementById('hiddenPaymentStatus').value = 'pending_bank';
    submitOrder({ paymentProvider: 'virement' });
    return;
  } else if(moyen === 'cb_simule'){
    // open simulation modal; when user confirms we'll call submitOrder
    openModalPaymentSimule();
    return;
  } else if(moyen === 'cash'){
    document.getElementById('hiddenPaymentStatus').value = 'pay_on_delivery';
    submitOrder({ paymentProvider: 'cash' });
    return;
  }
});

/* ===========================
   AUTH (localStorage simple)
   =========================== */
function getUsers(){ return JSON.parse(localStorage.getItem('users_v1') || '[]'); }
function saveUsers(u){ localStorage.setItem('users_v1', JSON.stringify(u)); }

function registerUserFromForm(fd){
  const users = getUsers();
  const email = (fd.get('reg_email') || '').toLowerCase();
  if(!email) return { ok:false, msg:'Email requis' };
  if(users.find(u=>u.email === email)) return { ok:false, msg:'Email d√©j√† utilis√©' };
  const newUser = {
    email: email,
    nom: fd.get('reg_nom') || '',
    prenom: fd.get('reg_prenom') || '',
    password: fd.get('reg_password') || ''
  };
  users.push(newUser);
  saveUsers(users);
  localStorage.setItem('currentUser_v1', JSON.stringify({ email: email }));
  updateAuthUI();
  return { ok:true };
}

function loginUserFromForm(fd){
  const users = getUsers();
  const email = (fd.get('login_email') || '').toLowerCase();
  const pwd = fd.get('login_password') || '';
  const u = users.find(x=> x.email === email && x.password === pwd);
  if(!u) return { ok:false, msg:'Email ou mot de passe incorrect' };
  localStorage.setItem('currentUser_v1', JSON.stringify({ email: email }));
  updateAuthUI();
  return { ok:true };
}

function getCurrentUser(){
  const cu = localStorage.getItem('currentUser_v1');
  if(!cu) return null;
  const info = JSON.parse(cu);
  const users = getUsers();
  return users.find(u=>u.email === info.email) || null;
}

function logout(){
  localStorage.removeItem('currentUser_v1');
  updateAuthUI();
  alert('D√©connect√©');
}

function updateAuthUI(){
  const u = getCurrentUser();
  if(u){
    document.getElementById('notLogged').style.display = 'none';
    document.getElementById('logged').style.display = 'flex';
    const nameDisplay = (u.prenom ? u.prenom : '') + (u.nom ? (' ' + u.nom) : '');
    document.getElementById('userBadge').textContent = nameDisplay || u.email;
    document.getElementById('userStatus').textContent = u.email;
  } else {
    document.getElementById('notLogged').style.display = 'flex';
    document.getElementById('logged').style.display = 'none';
    document.getElementById('userBadge').textContent = 'Invit√©';
    document.getElementById('userStatus').textContent = 'Invit√©';
  }
}

/* ===========================
   MODAL MANAGEMENT
   =========================== */
const modalContainer = document.getElementById('modalContainer');

function openModal(htmlContent){
  modalContainer.innerHTML = '';
  modalContainer.setAttribute('aria-hidden','false');
  const backdrop = document.createElement('div');
  backdrop.className = 'modal-backdrop';
  const modal = document.createElement('div');
  modal.className = 'modal';
  modal.innerHTML = htmlContent;
  backdrop.appendChild(modal);
  modalContainer.appendChild(backdrop);
}

function closeModal(){
  modalContainer.innerHTML = '';
  modalContainer.setAttribute('aria-hidden','true');
}

/* Login & register modals */
function openLoginModal(){
  openModal(`
    <h3>Connexion</h3>
    <form id="loginFormModal">
      <label>Email</label><input name="login_email" type="email" required />
      <label>Mot de passe</label><input name="login_password" type="password" required />
      <div style="display:flex; gap:8px; margin-top:12px">
        <button class="btn-primary" type="submit">Se connecter</button>
        <button type="button" class="btn-ghost" id="cancelLogin">Annuler</button>
      </div>
      <p style="margin-top:10px; font-size:13px">Pas de compte ? <a href="#" id="toRegister">Inscription</a></p>
    </form>
  `);

  // events
  document.getElementById('cancelLogin').onclick = closeModal;
  document.getElementById('toRegister').onclick = (e) => { e.preventDefault(); closeModal(); openRegisterModal(); };

  document.getElementById('loginFormModal').addEventListener('submit', function(e){
    e.preventDefault();
    const fd = new FormData(e.target);
    const res = loginUserFromForm(fd);
    if(!res.ok) alert(res.msg);
    else { alert('Connect√©'); closeModal(); }
  });
}

function openRegisterModal(){
  openModal(`
    <h3>Inscription</h3>
    <form id="regFormModal">
      <label>Pr√©nom</label><input name="reg_prenom" type="text" required />
      <label>Nom</label><input name="reg_nom" type="text" required />
      <label>Email</label><input name="reg_email" type="email" required />
      <label>Mot de passe</label><input name="reg_password" type="password" required />
      <div style="display:flex; gap:8px; margin-top:12px">
        <button class="btn-primary" type="submit">S'inscrire</button>
        <button type="button" class="btn-ghost" id="cancelReg">Annuler</button>
      </div>
    </form>
  `);
  document.getElementById('cancelReg').onclick = closeModal;
  document.getElementById('regFormModal').addEventListener('submit', function(e){
    e.preventDefault();
    const fd = new FormData(e.target);
    const res = registerUserFromForm(fd);
    if(!res.ok) alert(res.msg);
    else { alert('Inscription r√©ussie'); closeModal(); }
  });
}

/* Payment simulation modal */
function openModalPaymentSimule(){
  openModal(`
    <h3>Paiement par carte ‚Äî Simulation</h3>
    <p class="muted-note">Ceci est une simulation. En production, int√©grez Stripe ou un PSP s√©curis√©.</p>
    <label>Num√©ro de carte</label><input id="simCardNum" type="text" placeholder="4242 4242 4242 4242" />
    <div style="display:flex; gap:8px; margin-top:8px">
      <div style="flex:1"><label>MM/AA</label><input id="simCardDate" type="text" placeholder="12/34" /></div>
      <div style="width:120px"><label>CVV</label><input id="simCardCvv" type="text" placeholder="123" /></div>
    </div>
    <div style="display:flex; gap:8px; margin-top:12px">
      <button class="btn-primary" id="confirmSimCard">Payer (simul√©)</button>
      <button class="btn-ghost" id="cancelSimCard">Annuler</button>
    </div>
  `);

  document.getElementById('cancelSimCard').onclick = closeModal;
  document.getElementById('confirmSimCard').onclick = () => {
    closeModal();
    document.getElementById('hiddenPaymentStatus').value = 'paid_card_simule';
    submitOrder({ paymentProvider: 'card_simulated' });
  };
}

/* ===========================
   EVENT BINDINGS / INIT
   =========================== */
document.getElementById('btnAccueil').addEventListener('click', ()=>showSection('accueil'));
document.getElementById('btnBoutique').addEventListener('click', ()=>{ renderProducts(); showSection('boutique'); });
document.getElementById('btnPanier').addEventListener('click', ()=>{ renderCartTable(); showSection('cart'); });

document.getElementById('btnClearCart').addEventListener('click', clearCart);
document.getElementById('btnCheckoutCart').addEventListener('click', ()=> openFormFor('cart'));
document.getElementById('btnCancelOrder').addEventListener('click', ()=> showSection('boutique'));

document.getElementById('openLogin').addEventListener('click', openLoginModal);
document.getElementById('openRegister').addEventListener('click', openRegisterModal);
document.getElementById('logoutBtn').addEventListener('click', logout);

/* Delegate clicks on product grid (view / add) */
document.getElementById('productsGrid').addEventListener('click', function(e){
  const btn = e.target.closest('button');
  if(!btn) return;
  const action = btn.getAttribute('data-action');
  const id = btn.getAttribute('data-id');
  if(action === 'view') openProduct(id);
  if(action === 'add') addToCart(id, 1);
});

/* Delegate clicks in cart table (inc/dec/rm) */
document.getElementById('cartTable').addEventListener('click', function(e){
  const btn = e.target.closest('button');
  if(!btn) return;
  const action = btn.getAttribute('data-action');
  const idx = Number(btn.getAttribute('data-idx'));
  if(action === 'dec') changeQty(idx, -1);
  if(action === 'inc') changeQty(idx, 1);
  if(action === 'rm') removeFromCart(idx);
});

/* Initialize page */
function init(){
  renderProducts();
  updateCartUI();
  updateAuthUI();
  showSection('accueil');
}
window.addEventListener('load', init);

/* Expose some functions to window for inline use if needed */
window.openProduct = openProduct;
window.addToCart = addToCart;
window.openFormFor = openFormFor;
window.openModalPaymentSimule = openModalPaymentSimule;
window.showSection = showSection;

</script>
</body>
</html>
