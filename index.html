<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Objets 3D ‚Äî Axel & Noah</title>

<!-- PayPal SDK : remplacez YOUR_PAYPAL_CLIENT_ID par votre client-id r√©el -->
<script src="https://www.paypal.com/sdk/js?client-id=YOUR_PAYPAL_CLIENT_ID&currency=EUR" defer></script>

<style>
  :root{
    --accent:#ff6600;
    --bg:#fafafa;
    --card:#ffffff;
    --dark:#222;
    --muted:#666;
    --maxw:980px;
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    font-family:Inter, "Segoe UI", Roboto, Arial, sans-serif;
    background:var(--bg);
    color:#111;
    -webkit-font-smoothing:antialiased;
    -moz-osx-font-smoothing:grayscale;
  }

  /* HEADER */
  header{
    position:fixed;
    top:0; left:0; right:0;
    height:64px;
    background:linear-gradient(180deg,#111 0%, #1a1a1a 100%);
    color:white;
    display:flex;
    align-items:center;
    justify-content:space-between;
    padding:0 16px;
    z-index:2000;
    box-shadow:0 4px 18px rgba(0,0,0,0.25);
  }
  .brand{
    display:flex;
    gap:12px;
    align-items:center;
  }
  .logo {
    width:44px; height:44px; border-radius:10px;
    background:var(--accent); display:flex; align-items:center; justify-content:center;
    font-weight:700; color:white;
  }
  .brand h1{ font-size:18px; margin:0; letter-spacing:0.2px; }
  nav.main {
    display:flex; gap:12px; align-items:center;
  }
  button.icon-btn{
    background:transparent; border:none; color:white; cursor:pointer; font-size:16px;
    padding:8px 10px; border-radius:8px;
  }
  button.icon-btn:hover{ background:rgba(255,255,255,0.04) }

  /* Layout */
  main{ padding-top:84px; max-width:var(--maxw); margin:24px auto; padding-left:16px; padding-right:16px; }

  /* Hero */
  .hero{ display:flex; gap:20px; align-items:center; justify-content:space-between; background:linear-gradient(90deg,#fff 0%, #fffaf0 100%); padding:24px; border-radius:12px; box-shadow:0 6px 30px rgba(0,0,0,0.05); }
  .hero .left h2{ margin:0 0 8px 0; color:var(--dark); }
  .hero .left p{ margin:0; color:var(--muted) }

  /* Grid for boutique */
  .grid {
    margin-top:20px;
    display:grid;
    grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
    gap:18px;
  }
  .card{
    background:var(--card);
    border-radius:12px;
    padding:14px;
    box-shadow:0 6px 18px rgba(0,0,0,0.06);
    display:flex;
    flex-direction:column;
    gap:12px;
  }
  .product-container {
  display: grid;
  grid-template-columns: 80px 1fr 1fr;
  gap: 25px;
  margin: 40px;
  align-items: start;
}

.thumbs {
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.thumb {
  width: 70px;
  height: 70px;
  background: #f1f1f1;
  border-radius: 6px;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:12px;
  color:#777;
  cursor:pointer;
}

.main-image {
  display:flex;
  justify-content:center;
  align-items:center;
}

.image-placeholder {
  width: 450px;
  height: 450px;
  background:#e1e1e1;
  border-radius:10px;
  display:flex;
  justify-content:center;
  align-items:center;
  color:#555;
  font-size:18px;
}

.product-info h1 {
  font-size: 28px;
  font-weight: bold;
}
.price-line {
  display:flex;
  align-items:center;
  gap:10px;
}
.soldout-badge {
  background:black;
  color:white;
  padding:3px 8px;
  border-radius:6px;
  font-size:12px;
}

.reviews {
  color: gold;
  font-weight:bold;
}
.slogan {
  font-size:14px;
  margin-bottom:10px;
  color:#333;
}

.color-selector{
  display:flex;
  gap:8px;
  margin:10px 0;
}

.color-item{
  width:26px;
  height:26px;
  border-radius:50%;
  border:2px solid #ccc;
  cursor:pointer;
}

.quantity-box {
  margin:10px 0;
}

.add-cart-btn {
  margin-top:10px;
  padding:10px 15px;
  background:black;
  color:white;
  border:none;
  border-radius:8px;
  cursor:pointer;
  font-size:16px;
}
  .card img{ width:100%; height:140px; object-fit:cover; border-radius:8px; }
  .card h3{ margin:0; font-size:16px; color:var(--dark) }
  .card p{ margin:0; color:var(--muted); font-size:14px; min-height:40px; }
  .card .meta{ display:flex; align-items:center; justify-content:space-between; gap:8px }
  .price{ font-weight:700; color:var(--accent) }

  /* Details View */
  #detailsSection { display:none; margin-top:18px; }
  .details-wrap{ display:flex; gap:18px; align-items:flex-start; }
  .details-left{ flex:1; }
  .details-right{ width:320px; background:var(--card); padding:14px; border-radius:12px; box-shadow:0 6px 18px rgba(0,0,0,0.06) }
  .carousel-main{ width:100%; height:300px; border-radius:10px; overflow:hidden; background:#eee; display:flex; align-items:center; justify-content:center; }
  .carousel-main img{ width:100%; height:100%; object-fit:cover; }
  .thumbnails{ display:flex; gap:8px; margin-top:8px; }
  .thumbnails img{ height:56px; width:75px; object-fit:cover; border-radius:6px; cursor:pointer; opacity:.75; border:2px solid transparent }
  .thumbnails img.active{ opacity:1; border-color:var(--accent) }

  /* Formulaire / panier */
  #formSection{ display:none; margin-top:18px; }
  form.card-form{ display:flex; flex-direction:column; gap:10px; }
  label{ font-size:13px; color:var(--muted); margin-bottom:6px }
  input[type="text"], input[type="email"], input[type="number"], select, textarea {
    padding:10px; border-radius:8px; border:1px solid #ddd; background:white; font-size:14px;
  }
  textarea{ min-height:80px; resize:vertical; }
  .btn-primary{ background:var(--accent); color:white; border:none; padding:12px; border-radius:8px; cursor:pointer; font-weight:700 }
  .btn-ghost{ background:#f5f5f5; border:1px solid #eee; padding:10px; border-radius:8px; cursor:pointer }

  /* Panier table */
  table.cart{ width:100%; border-collapse:collapse; background:var(--card); border-radius:12px; overflow:hidden; box-shadow:0 6px 18px rgba(0,0,0,0.06) }
  table.cart th, table.cart td{ padding:12px 14px; text-align:left; border-bottom:1px solid #f0f0f0; font-size:14px }
  table.cart thead{ background:#fafafa }
  .small-muted{ font-size:13px; color:var(--muted) }

  /* Auth area small badge + list */
  .auth-badge{ display:flex; gap:8px; align-items:center; background:transparent; color:white }
  .user-bubble{ background:rgba(255,255,255,0.06); padding:6px 10px; border-radius:8px; font-weight:600; color:#fff }

  .connected-list{ margin-top:10px; padding:12px; background:#fff; border-radius:10px; box-shadow:0 6px 18px rgba(0,0,0,0.04) }
  .connected-list h4{ margin:0 0 8px 0 }
  .connected-list ul{ margin:0; padding-left:18px; color:var(--muted) }

  /* Modal backdrop + modal content */
  .modal-backdrop{ position:fixed; inset:0; display:flex; align-items:center; justify-content:center; background:rgba(0,0,0,0.5); z-index:3000 }
  .modal{ width:100%; max-width:480px; background:white; padding:18px; border-radius:12px; box-shadow:0 12px 40px rgba(0,0,0,0.25) }
  .modal h3{ margin:0 0 12px 0 }
  .modal .actions{ display:flex; gap:8px; margin-top:12px }
  .muted-note{ font-size:13px; color:var(--muted) }

  /* Ensure inputs in modals are stacked in column */
  .modal form{
    display:flex;
    flex-direction:column;
    gap:10px;
  }
  .modal label{ margin-bottom:4px; }

  /* Footer reduced */
  footer.site-footer{
    margin-top:28px;
    background:#0f0f0f; color:#ddd; padding:12px 16px; border-radius:10px;
    max-width:var(--maxw); margin-left:auto; margin-right:auto; display:flex; justify-content:space-between; align-items:center; gap:12px;
  }
  .footer-left{ font-size:14px }
  .footer-contact{ text-align:right; font-size:13px; color:#aaa }
  .footer-contact ul{ margin:6px 0 0 0; padding-left:18px; color:#ccc }

  .footer-social{ display:flex; gap:8px; align-items:center; }
  .footer-social a img{ height:36px; width:36px; border-radius:6px; display:block; }

  /* Responsive */
  @media (max-width:860px){
    .details-wrap{ flex-direction:column }
    .details-right{ width:100% }
    footer.site-footer{ flex-direction:column; gap:10px; text-align:center }
  }
</style>
</head>
<body>

<header>
  <div class="brand">
    <div class="logo">3D</div>
    <div>
      <h1 style="margin:0">Objets 3D ‚Äî Axel & Noah</h1>
      <div style="font-size:12px;color:#e6e6e6">Impression & Cr√©ation locale</div>
    </div>
  </div>

  <nav class="main" aria-label="Navigation principale">
    <button class="icon-btn" id="navAccueil">Accueil</button>
    <button class="icon-btn" id="navBoutique">Boutique</button>
    <button class="icon-btn" id="navPanier">üõí <span id="nbPanier">0</span></button>

    <div id="authArea" style="display:flex; align-items:center; gap:8px">
      <div id="notLogged" style="display:flex; gap:8px">
        <button class="icon-btn" id="openLoginBtn">Connexion</button>
        <button class="icon-btn" id="openRegisterBtn">Inscription</button>
      </div>
      <div id="logged" style="display:none; align-items:center; gap:8px">
        <div class="user-bubble" id="badgeUser">Utilisateur</div>
        <button class="icon-btn" id="logoutBtn">D√©connexion</button>
      </div>
    </div>
  </nav>
</header>

<main>
  <!-- HERO -->
  <section class="hero" id="accueilSection" style="margin-top:20px;">
    <div class="card" style="padding:20px;">
      <h2>Bienvenue sur notre boutique d‚Äôobjets 3D</h2>
      <p style="font-size:15px; color:#444; line-height:1.6;">
        Nous sommes <strong>Axel et Noah</strong>, deux adolescents de <strong>15 ans</strong> passionn√©s par la
        cr√©ation et l‚Äôimpression 3D.  
        Nous avons d√©cid√© de lancer notre propre petite entreprise pour montrer que l‚Äô<strong>entreprenariat</strong>
        et la <strong>cr√©ativit√©</strong> ne sont pas r√©serv√©s aux adultes : les jeunes peuvent aussi innover,
        entreprendre et b√¢tir leurs propres projets.
        <br><br>
        Pour nous, la <strong>cr√©ativit√© est la cl√© de la r√©ussite</strong>.  
        Chaque objet que nous proposons est imagin√©, fabriqu√© et emball√© avec soin dans notre atelier local.
        Merci de soutenir notre aventure !
      </p>
    </div>

    <div class="left">
      <h2>Objets 3D faits main ‚Äî Petite boutique</h2>
      <p>Produits imprim√©s localement, personnalisables. Paiement PayPal / CB (simulation) / √† la livraison.</p>
    </div>

    <div style="display:flex; gap:12px; align-items:center">
      <div style="text-align:right;">
        <div style="font-size:12px;color:var(--muted)">Connect√© en tant que :</div>
        <div id="userStatus" style="font-weight:700;color:var(--accent)">Invit√©</div>
      </div>
      <div style="background:#fff; padding:8px 12px; border-radius:8px; box-shadow:0 6px 18px rgba(0,0,0,0.06)">
        <div style="font-size:13px; color:var(--muted)">Panier</div>
        <div style="font-weight:700; font-size:18px" id="nbPanierLarge">0</div>
      </div>
    </div>
  </section>

  <!-- BOUTIQUE -->
  <section id="boutiqueSection" style="margin-top:18px; display:none;">
    <h3>Nos produits</h3>
    <div class="grid" id="gridProduits">
      <!-- cartes remplies par JS -->
    </div>
  </section>

  <!-- DETAILS (unique) -->
  <section id="detailsSection">
    <div class="details-wrap">
      <div class="details-left">
        <div class="card">
          <div class="carousel-main" id="mainImageContainer"><img id="mainImage" src="" alt="image objet" /></div>
          <div class="thumbnails" id="thumbs"></div>
        </div>

        <div class="card" style="margin-top:12px">
          <h3 id="detailTitre">Titre</h3>
          <p id="detailDescription" class="small-muted">Description...</p>
          <p class="small-muted" id="detailFab">Fabriqu√© √† ...</p>
        </div>
      </div>

      <aside class="details-right">
        <div style="display:flex; justify-content:space-between; align-items:center">
          <div style="font-weight:700" id="detailPrix">‚Ç¨0.00</div>
          <div style="color:var(--muted); font-size:13px" id="detailQty">Stock : ‚Äî</div>
        </div>

        <div style="margin-top:12px">
          <label for="detailQuantiteInput">Quantit√©</label>
          <input type="number" id="detailQuantiteInput" min="1" value="1" />
        </div>

        <div style="margin-top:12px; display:flex; gap:8px">
          <button class="btn-primary" id="btnAddToCart">Ajouter au panier</button>
          <button class="btn-ghost" id="btnOrderSingle">Commander</button>
        </div>

        <div style="margin-top:16px; font-size:13px; color:var(--muted)">
          <strong>D√©tails techniques</strong>
          <div id="detailTech" style="margin-top:8px">PLA recycl√© ‚Ä¢ Impression FDM</div>
        </div>
      </aside>
    </div>
  </section>

  <!-- PANIER -->
  <section id="panierSection" style="margin-top:18px; display:none;">
    <h3>Panier</h3>
    <div style="overflow:auto;">
      <table class="cart" aria-live="polite">
        <thead>
          <tr><th>Produit</th><th>Quantit√©</th><th>Prix</th><th>Actions</th></tr>
        </thead>
        <tbody id="panierTable"></tbody>
      </table>
    </div>
    <div style="display:flex; justify-content:space-between; margin-top:12px; align-items:center">
      <div>
        <button class="btn-ghost" id="viderPanierBtn">Vider le panier</button>
      </div>
      <div style="text-align:right">
        <div class="small-muted">Total :</div>
        <div style="font-weight:700; font-size:18px" id="totalPanier">‚Ç¨0.00</div>
        <div style="margin-top:8px">
          <button class="btn-primary" id="commanderPanierBtn">Commander le panier</button>
        </div>
      </div>
    </div>
  </section>

  <!-- FORMULAIRE / COMMANDE -->
  <section id="formSection" style="margin-top:18px; display:none;">
    <h3>Commander</h3>
    <div class="card">
      <form id="orderForm" class="card-form">
        <div>
          <label for="nom">Nom</label>
          <input id="nom" name="nom" type="text" required />
        </div>
        <div>
          <label for="prenom">Pr√©nom</label>
          <input id="prenom" name="prenom" type="text" required />
        </div>
        <div>
          <label for="adresse">Adresse</label>
          <input id="adresse" name="adresse" type="text" required />
        </div>
        <div style="display:flex; gap:8px">
          <div style="flex:1">
            <label for="codepostal">Code postal</label>
            <input id="codepostal" name="codepostal" type="text" pattern="[0-9]{5}" />
          </div>
          <div style="flex:1">
            <label for="email">Email</label>
            <input id="emailField" name="email" type="email" required />
          </div>
        </div>

        <div>
          <label for="quantite">Quantit√© totale</label>
          <input id="quantite" name="quantite" type="number" min="1" value="1" />
        </div>

        <div>
          <label for="moyenPaiement">Moyen de paiement</label>
          <select id="moyenPaiement" name="moyenPaiement" onchange="onMoyenChange()" required>
            <option value="">-- Choisir un moyen de paiement --</option>
            <option value="paypal">PayPal</option>
            <option value="paypalme">PayPal.me</option>
            <option value="virement">Virement bancaire</option>
            <option value="cb_simule">Carte bancaire (simulation)</option>
            <option value="cash">Paiement √† la livraison</option>
          </select>
        </div>

        <div id="paypal-button-container" style="margin-top:8px; display:none"></div>

        <!-- hidden: d√©tail des objets -->
        <input type="hidden" id="objetHidden" name="objet" />
        <input type="hidden" id="paymentStatus" name="payment_status" value="pending" />

        <div style="display:flex; gap:8px; margin-top:8px">
          <button class="btn-primary" type="submit" id="btnSubmit">Envoyer la commande</button>
          <button type="button" class="btn-ghost" id="btnCancelOrder">Annuler</button>
        </div>
        <p class="muted-note">Remarque : la CB est simul√©e ici. Pour paiements r√©els, int√©grer Stripe (backend requis).</p>
      </form>
    </div>
  </section>

  <!-- Modals placeholder -->
  <div id="modalWrapper" aria-hidden="true"></div>

</main>

<!-- FOOTER r√©duit -->
<footer class="site-footer" role="contentinfo">
  <div class="footer-left">
    <strong>Contact rapide</strong><br>
    <span class="small-muted">objet.3d.axel.et.noah@gmail.com</span>
  </div>
  <div class="footer-contact">
    <div><strong>Quand vous √™tes connect√© :</strong></div>
    <ul>
      <li>Voir le panier et commander le panier</li>
      <li>Enregistrer vos moyens de paiement</li>
      <li>Recevoir des notifications par e-mail</li>
    </ul>

    <div style="margin-top:8px" class="footer-social">
      <!-- Instagram -->
      <a href="https://www.instagram.com/objet_3d_a_et_n/" target="_blank" aria-label="Instagram">
        <img src="https://upload.wikimedia.org/wikipedia/commons/e/e7/Instagram_logo_2016.svg" alt="Instagram">
      </a>
      <!-- TikTok (remplacez le lien par le v√¥tre si n√©cessaire) -->
      <a href="https://www.tiktok.com/@objet_3d" target="_blank" aria-label="TikTok">
        <img src="https://upload.wikimedia.org/wikipedia/en/a/a9/TikTok_logo.svg" alt="TikTok">
      </a>
    </div>
  </div>
</footer>

<script>
/* ===========================
   Donn√©es produits
   =========================== */
const produits = {
  objet1: {
    id: 'objet1',
    titre: 'Porte-stylo √âco',
    description: 'Porte-stylo √©l√©gant imprim√© en PLA recycl√©. Dimensions : 8x8x10 cm.',
    images: [
      'https://via.placeholder.com/800x600?text=Porte-stylo+1',
      'https://via.placeholder.com/800x600?text=Porte-stylo+2'
    ],
    fabrication: 'Marcoussis, France',
    prix: 9.90,
    stock: 12,
    tech: 'PLA recycl√© ‚Ä¢ 0.2mm layer'
  },
  objet2: {
    id: 'objet2',
    titre: 'Support Smartphone',
    description: 'Support pour smartphone compatible grand format.',
    images: [
      'https://via.placeholder.com/800x600?text=Support+1',
      'https://via.placeholder.com/800x600?text=Support+2'
    ],
    fabrication: 'Marcoussis, France',
    prix: 12.50,
    stock: 6,
    tech: 'PLA+ ‚Ä¢ 0.16mm layer'
  },
  objet3: {
    id: 'objet3',
    titre: 'D√©coration Personnalis√©e',
    description: 'D√©coration personnalisable ‚Äî envoi avec emballage soign√©.',
    images: [
      'https://via.placeholder.com/800x600?text=Deco+1',
      'https://via.placeholder.com/800x600?text=Deco+2',
      'https://via.placeholder.com/800x600?text=Deco+3'
    ],
    fabrication: 'Marcoussis, France',
    prix: 18.00,
    stock: 4,
    tech: 'PLA + finitions peinture'
  }
};

/* ===========================
   State global
   =========================== */
let panier = JSON.parse(localStorage.getItem('panier_v2')) || []; // [{id, titre, prix, quantite}]
let paypalRendered = false;

/* ===========================
   Helpers
   =========================== */
function escapeHtml(s){
  if(!s) return '';
  return String(s).replace(/[&<>"']/g, function(m){ return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[m]; });
}

function sauvegarderPanier(){ localStorage.setItem('panier_v2', JSON.stringify(panier)); }
function calculerTotalPanier(){ return panier.reduce((s,i) => s + (i.prix || 0) * i.quantite, 0); }

/* ===========================
   Initialisation affichage
   =========================== */
function init(){
  renderProduits();
  updatePanierUI();
  afficherAccueil();
  updateAuthUI();
  attachGlobalHandlers();
}
window.addEventListener('load', init);

/* ===========================
   Rendu produits
   =========================== */
function renderProduits(){
  const grid = document.getElementById('gridProduits');
  grid.innerHTML = '';
  Object.values(produits).forEach(p => {
    const card = document.createElement('div');
    card.className = 'card';
    card.innerHTML = `
      <img src="${escapeHtml(p.images[0])}" alt="${escapeHtml(p.titre)}" />
      <h3>${escapeHtml(p.titre)}</h3>
      <p>${escapeHtml(p.description)}</p>
      <div class="meta">
        <div class="price">‚Ç¨${p.prix.toFixed(2)}</div>
        <div>
          <button class="btn-ghost" data-action="voir" data-id="${p.id}">Voir</button>
          <button class="btn-primary" data-action="ajouter" data-id="${p.id}">Ajouter</button>
        </div>
      </div>
    `;
    grid.appendChild(card);
  });
}

/* ===========================
   Navigation affichage
   =========================== */
function afficherAccueil(){
  document.getElementById('accueilSection').style.display = 'block';
  document.getElementById('boutiqueSection').style.display = 'none';
  document.getElementById('detailsSection').style.display = 'none';
  document.getElementById('panierSection').style.display = 'none';
  document.getElementById('formSection').style.display = 'none';
  window.scrollTo({top:0, behavior:'smooth'});
}

function afficherBoutique(){
  document.getElementById('accueilSection').style.display = 'none';
  document.getElementById('boutiqueSection').style.display = 'block';
  document.getElementById('detailsSection').style.display = 'none';
  document.getElementById('panierSection').style.display = 'none';
  document.getElementById('formSection').style.display = 'none';
  window.scrollTo({top:0, behavior:'smooth'});
}

function afficherPanier(){
  document.getElementById('accueilSection').style.display = 'none';
  document.getElementById('boutiqueSection').style.display = 'none';
  document.getElementById('detailsSection').style.display = 'none';
  document.getElementById('panierSection').style.display = 'block';
  document.getElementById('formSection').style.display = 'none';
  renderPanierTable();
  window.scrollTo({top:0, behavior:'smooth'});
}

/* ===========================
   Afficher d√©tails produit
   =========================== */
function afficherDetails(id){
  const p = produits[id];
  if(!p) return alert('Produit introuvable.');
  document.getElementById('accueilSection').style.display = 'none';
  document.getElementById('boutiqueSection').style.display = 'none';
  document.getElementById('detailsSection').style.display = 'block';
  document.getElementById('panierSection').style.display = 'none';
  document.getElementById('formSection').style.display = 'none';

  // remplir d√©tails
  document.getElementById('mainImage').src = p.images[0];
  document.getElementById('detailTitre').textContent = p.titre;
  document.getElementById('detailDescription').textContent = p.description;
  document.getElementById('detailFab').textContent = p.fabrication;
  document.getElementById('detailPrix').textContent = "‚Ç¨" + p.prix.toFixed(2);
  document.getElementById('detailQty').textContent = "Stock : " + p.stock;
  document.getElementById('detailTech').textContent = p.tech;
  document.getElementById('detailQuantiteInput').value = 1;

  // miniatures
  const thumbs = document.getElementById('thumbs');
  thumbs.innerHTML = '';
  p.images.forEach((src, i) => {
    const img = document.createElement('img');
    img.src = src;
    img.style.cursor = 'pointer';
    if(i===0) img.classList.add('active');
    img.onclick = () => {
      document.querySelectorAll('#thumbs img').forEach(x=>x.classList.remove('active'));
      img.classList.add('active');
      document.getElementById('mainImage').src = src;
    };
    thumbs.appendChild(img);
  });

  // attacher le bouton ajouter
  const btnAdd = document.getElementById('btnAddToCart');
  btnAdd.onclick = () => {
    const q = parseInt(document.getElementById('detailQuantiteInput').value || 1, 10);
    ajouterAuPanier(id, q);
  };
  // bouton commander (ouvre form pour single)
  const commanderBtn = document.getElementById('btnOrderSingle');
  commanderBtn.onclick = () => ouvrirFormulairePour(id);
  window.scrollTo({top:0, behavior:'smooth'});
}

/* ===========================
   Panier : fonctions
   =========================== */
function ajouterAuPanier(id, quantite=1){
  const p = produits[id];
  if(!p) return alert('Produit introuvable');
  quantite = Number(quantite) || 1;
  if(quantite < 1) return alert('Quantit√© invalide');
  // v√©rification stock : somme des quantit√©s d√©j√† dans le panier + nouvelle <= stock
  const existing = panier.find(x=>x.id===id);
  const currentInCart = existing ? existing.quantite : 0;
  if(currentInCart + quantite > p.stock) return alert('Quantit√© demand√©e sup√©rieure au stock disponible.');

  if(existing) existing.quantite += quantite;
  else panier.push({ id:p.id, titre:p.titre, prix:p.prix, quantite:quantite });
  sauvegarderPanier();
  updatePanierUI();
  alert(p.titre + ' ajout√© au panier');
}

function ajouterPanierParBtn(id){
  ajouterAuPanier(id, 1);
}

function updatePanierUI(){
  const totalQte = panier.reduce((s,i)=>s + i.quantite, 0);
  // s√©curiser √©l√©ments pr√©sents
  const nb = document.getElementById('nbPanier');
  const nbLarge = document.getElementById('nbPanierLarge');
  if(nb) nb.textContent = totalQte;
  if(nbLarge) nbLarge.textContent = totalQte;
  renderPanierTable();
}

function renderPanierTable(){
  const tbody = document.getElementById('panierTable');
  tbody.innerHTML = '';
  if(!panier || panier.length===0){
    const tr = document.createElement('tr');
    tr.innerHTML = '<td colspan="4">Votre panier est vide.</td>';
    tbody.appendChild(tr);
    const totalEl = document.getElementById('totalPanier');
    if(totalEl) totalEl.textContent = '‚Ç¨0.00';
    updatePanierUI();
    return;
  }
  panier.forEach((it, idx) => {
    const tr = document.createElement('tr');
    const totalPrice = (it.prix * it.quantite).toFixed(2);
    tr.innerHTML = `
      <td>${escapeHtml(it.titre)}</td>
      <td>${it.quantite}</td>
      <td>‚Ç¨${totalPrice}</td>
      <td>
        <button class="btn-ghost" data-action="dec" data-idx="${idx}">-</button>
        <button class="btn-ghost" data-action="inc" data-idx="${idx}">+</button>
        <button class="btn-ghost" data-action="rm" data-idx="${idx}">Supprimer</button>
      </td>
    `;
    tbody.appendChild(tr);
  });
  const total = calculerTotalPanier();
  document.getElementById('totalPanier').textContent = '‚Ç¨' + total.toFixed(2);
}

/* modifier quantit√© & suppression via √©couteur d√©l√©gu√© */
document.addEventListener('click', function(e){
  const b = e.target.closest('button[data-action]');
  if(!b) return;
  const action = b.getAttribute('data-action');
  const idx = parseInt(b.getAttribute('data-idx'), 10);
  if(action === 'dec') modifierQuantite(idx, -1);
  if(action === 'inc') modifierQuantite(idx, 1);
  if(action === 'rm') supprimerArticle(idx);
});

function modifierQuantite(index, delta){
  if(!panier[index]) return;
  panier[index].quantite += delta;
  if(panier[index].quantite <= 0) panier.splice(index,1);
  sauvegarderPanier();
  renderPanierTable();
}

function supprimerArticle(index){
  if(!panier[index]) return;
  if(confirm('Supprimer ' + panier[index].titre + ' du panier ?')) {
    panier.splice(index,1);
    sauvegarderPanier();
    renderPanierTable();
  }
}

function viderPanier(){
  if(!confirm('Vider compl√®tement le panier ?')) return;
  panier = [];
  sauvegarderPanier();
  renderPanierTable();
}

/* ===========================
   Commander le panier -> ouvrir formulaire
   =========================== */
function commanderPanier(){
  if(!panier || panier.length===0) return alert('Votre panier est vide.');
  const textePanier = panier.map(p => `${p.titre} x ${p.quantite}`).join(' ; ');
  ouvrirFormulairePour('panier');
  document.getElementById('objetHidden').value = textePanier;
  const totalQte = panier.reduce((s,i)=>s+i.quantite, 0);
  document.getElementById('quantite').value = totalQte;
}

/* Ouvrir formulaire pour single product or panier */
function ouvrirFormulairePour(idOrPanier){
  // pr√©remplir formulaire si utilisateur connect√©
  const user = getCurrentUser();
  if(user){
    document.getElementById('nom').value = user.nom || '';
    document.getElementById('prenom').value = user.prenom || '';
    document.getElementById('emailField').value = user.email || '';
  }
  if(idOrPanier === 'panier' || idOrPanier === 'panierAll'){
    const textePanier = panier.map(p => `${p.titre} x ${p.quantite}`).join(' ; ');
    document.getElementById('objetHidden').value = textePanier;
    const totalQte = panier.reduce((s,i)=>s+i.quantite, 0);
    document.getElementById('quantite').value = totalQte;
  } else {
    // produit unique
    const p = produits[idOrPanier];
    if(!p) return;
    document.getElementById('objetHidden').value = p.titre;
    document.getElementById('quantite').value = document.getElementById('detailQuantiteInput').value || 1;
  }
  // afficher la section commande
  document.getElementById('boutiqueSection').style.display = 'none';
  document.getElementById('detailsSection').style.display = 'none';
  document.getElementById('panierSection').style.display = 'none';
  document.getElementById('formSection').style.display = 'block';
  window.scrollTo({top:0, behavior:'smooth'});
}

/* ===========================
   Gestion moyens de paiement
   =========================== */
function onMoyenChange(){
  const m = document.getElementById('moyenPaiement').value;
  const paypalContainer = document.getElementById('paypal-button-container');
  if(m === 'paypal'){
    paypalContainer.style.display = 'block';
    renderPaypalButton();
  } else if(m === 'paypalme'){
    paypalContainer.style.display = 'none';
    // on n'ouvre pas automatiquement pour ne pas surprendre l'utilisateur
  } else if(m === 'virement'){
    paypalContainer.style.display = 'none';
    alert('Virement bancaire :\nIBAN: FR76 XXXX XXXX XXXX XXXX XXXX\nBIC: XXXXXXX\nTitulaire: Axel & Noah');
  } else if(m === 'cb_simule'){
    paypalContainer.style.display = 'none';
    // modal opened on submit
  } else {
    paypalContainer.style.display = 'none';
  }
}

/* Render PayPal button once */
function renderPaypalButton(){
  if(typeof paypal === 'undefined'){
    console.warn('PayPal SDK non charg√© (v√©rifiez client id).');
    return;
  }
  if(paypalRendered) return;
  paypalRendered = true;
  paypal.Buttons({
    style: { layout:'vertical', color:'gold', shape:'rect', label:'paypal' },
    createOrder: function(data, actions){
      const total = calculerTotalPanier();
      return actions.order.create({
        purchase_units: [{ amount: { value: total.toFixed(2) } }]
      });
    },
    onApprove: function(data, actions){
      return actions.order.capture().then(function(details){
        document.getElementById('paymentStatus').value = 'paid_paypal';
        submitOrder({ paymentProvider: 'paypal', paymentDetails: details });
      });
    },
    onError: function(err){
      alert('Erreur PayPal : ' + (err && err.message ? err.message : 'Erreur'));
    }
  }).render('#paypal-button-container');
}

/* ===========================
   Gestion envoi formulaire (Web3Forms)
   =========================== */
function handleOrderFormSubmit(e){
  e.preventDefault();
  const fd = new FormData(document.getElementById('orderForm'));
  const moyen = fd.get('moyenPaiement');

  if(!moyen){
    alert('Veuillez choisir un moyen de paiement.');
    return;
  }

  if(moyen === 'paypal'){
    if(document.getElementById('paymentStatus').value === 'paid_paypal'){
      submitOrder({ paymentProvider: 'paypal' });
    } else {
      alert('Veuillez finaliser le paiement PayPal via le bouton PayPal.');
    }
    return;
  } else if(moyen === 'paypalme'){
    // ouvrir paypal.me et consid√©rer la commande en pending
    window.open('https://paypal.me/objet_3d_a_et_n', '_blank');
    document.getElementById('paymentStatus').value = 'pending_paypalme';
    submitOrder({ paymentProvider: 'paypalme' });
    return;
  } else if(moyen === 'virement'){
    document.getElementById('paymentStatus').value = 'pending_bank';
    submitOrder({ paymentProvider: 'virement' });
    return;
  } else if(moyen === 'cb_simule'){
    // ouvrir modal de simulation, la confirmation appellera submitOrder()
    ouvrirModal('paymentSimule');
    return;
  } else if(moyen === 'cash'){
    document.getElementById('paymentStatus').value = 'pay_on_delivery';
    submitOrder({ paymentProvider: 'cash' });
    return;
  } else {
    alert('Moyen de paiement inconnu.');
    return;
  }
}

function submitOrder(extra = {}){
  const form = document.getElementById('orderForm');
  const fd = new FormData(form);
  const objet = fd.get('objet') || 'Aucun objet indiqu√©';
  const paymentMethod = fd.get('moyenPaiement') || extra.paymentProvider || 'inconnu';
  const currentUser = getCurrentUser();

  const message = `Commande: ${objet}
Nom: ${fd.get('nom')}
Pr√©nom: ${fd.get('prenom')}
Adresse: ${fd.get('adresse')}
Code Postal: ${fd.get('codepostal')}
Email: ${fd.get('email')}
Quantit√©: ${fd.get('quantite')}
Moyen de paiement: ${paymentMethod}
Utilisateur connect√©: ${currentUser ? currentUser.email : 'aucun'}`;

  const payload = {
    access_key: "867b9f7b-a375-47c5-a0c0-ec184b69f529",
    subject: `Nouvelle commande : ${objet}`,
    sender_name: fd.get('prenom') + ' ' + fd.get('nom'),
    sender_email: fd.get('email'),
    message: message,
    data: Object.fromEntries(fd.entries())
  };

  if(extra.paymentDetails) payload.payment_details = extra.paymentDetails;

  fetch('https://api.web3forms.com/submit', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(payload)
  })
  .then(res => res.json())
  .then(json => {
    if(json && json.success){
      alert('Commande re√ßue ‚Äî merci !');
      // vider panier si commande bas√©e sur panier
      const objField = objet || '';
      if(objField.includes(' x ') || objField.includes(';') || objField.toLowerCase().includes('panier')){
        panier = [];
        sauvegarderPanier();
      }
      form.reset();
      document.getElementById('paymentStatus').value = 'pending';
      updatePanierUI();
      afficherAccueil();
    } else {
      alert('Erreur lors de l\'envoi de la commande. R√©essayez.');
      console.error('web3forms error', json);
    }
  })
  .catch(err => {
    console.error(err);
    alert('Erreur r√©seau lors de l\'envoi de la commande.');
  });
}

/* ===========================
   Auth utilisateur (localStorage prototype)
   =========================== */
function getUsers(){ return JSON.parse(localStorage.getItem('users_v2') || '[]'); }
function saveUsers(u){ localStorage.setItem('users_v2', JSON.stringify(u)); }

function registerUser(formData){
  const users = getUsers();
  const email = (formData.get('reg_email') || '').toLowerCase();
  if(!email) return { ok:false, msg:'Email requis' };
  if(users.find(u=>u.email === email)) return { ok:false, msg:'Email d√©j√† utilis√©' };
  const newUser = {
    email: email,
    nom: formData.get('reg_nom') || '',
    prenom: formData.get('reg_prenom') || '',
    password: formData.get('reg_password') || ''
  };
  users.push(newUser);
  saveUsers(users);
  localStorage.setItem('currentUser_v2', JSON.stringify({ email: email }));
  updateAuthUI();
  return { ok:true };
}

function loginUser(formData){
  const users = getUsers();
  const email = (formData.get('login_email') || '').toLowerCase();
  const pwd = formData.get('login_password') || '';
  const u = users.find(x=> x.email === email && x.password === pwd);
  if(!u) return { ok:false, msg:'Email ou mot de passe incorrect' };
  localStorage.setItem('currentUser_v2', JSON.stringify({ email: email }));
  updateAuthUI();
  return { ok:true };
}

function getCurrentUser(){
  const cu = localStorage.getItem('currentUser_v2');
  if(!cu) return null;
  const info = JSON.parse(cu);
  const users = getUsers();
  return users.find(u=>u.email === info.email) || null;
}

function deconnexion(){
  localStorage.removeItem('currentUser_v2');
  updateAuthUI();
  alert('D√©connect√©');
}

function updateAuthUI(){
  const u = getCurrentUser();
  if(u){
    document.getElementById('notLogged').style.display = 'none';
    document.getElementById('logged').style.display = 'flex';
    const nameDisplay = (u.prenom ? u.prenom : '') + (u.nom ? (' ' + u.nom) : '');
    document.getElementById('badgeUser').textContent = nameDisplay || u.email;
    document.getElementById('userStatus').textContent = u.email;
  } else {
    document.getElementById('notLogged').style.display = 'flex';
    document.getElementById('logged').style.display = 'none';
    document.getElementById('badgeUser').textContent = 'Invit√©';
    document.getElementById('userStatus').textContent = 'Invit√©';
  }
}

/* ===========================
   Modal management (login / register / payment simule)
   =========================== */
const modalWrapper = document.getElementById('modalWrapper');

function ouvrirModal(mode){
  modalWrapper.innerHTML = '';
  modalWrapper.setAttribute('aria-hidden', 'false');
  const backdrop = document.createElement('div');
  backdrop.className = 'modal-backdrop';
  const modal = document.createElement('div');
  modal.className = 'modal';

  if(mode === 'login'){
    modal.innerHTML = `
      <h3>Connexion</h3>
      <form id="loginForm">
        <label>Email</label><input name="login_email" type="email" required />
        <label>Mot de passe</label><input name="login_password" type="password" required />
        <div class="actions">
          <button class="btn-primary" type="submit">Se connecter</button>
          <button type="button" class="btn-ghost" id="cancelLoginModal">Annuler</button>
        </div>
        <p class="muted-note">Pas de compte ? <a href="#" id="switchToRegister">Inscrivez-vous</a></p>
      </form>
    `;
    backdrop.appendChild(modal);
    modalWrapper.appendChild(backdrop);
    document.getElementById('cancelLoginModal').addEventListener('click', fermerModal);
    document.getElementById('switchToRegister').addEventListener('click', function(e){ e.preventDefault(); fermerModal(); ouvrirModal('register'); });
    document.getElementById('loginForm').addEventListener('submit', function(e){
      e.preventDefault();
      const fd = new FormData(e.target);
      const res = loginUser(fd);
      if(!res.ok) alert(res.msg);
      else { alert('Connect√©'); fermerModal(); }
    });
  } else if(mode === 'register'){
    modal.innerHTML = `
      <h3>Inscription</h3>
      <form id="regForm">
        <label>Pr√©nom</label><input name="reg_prenom" type="text" required />
        <label>Nom</label><input name="reg_nom" type="text" required />
        <label>Email</label><input name="reg_email" type="email" required />
        <label>Mot de passe</label><input name="reg_password" type="password" required />
        <div class="actions">
          <button class="btn-primary" type="submit">S'inscrire</button>
          <button type="button" class="btn-ghost" id="cancelRegModal">Annuler</button>
        </div>
      </form>
    `;
    backdrop.appendChild(modal);
    modalWrapper.appendChild(backdrop);
    document.getElementById('cancelRegModal').addEventListener('click', fermerModal);
    document.getElementById('regForm').addEventListener('submit', function(e){
      e.preventDefault();
      const fd = new FormData(e.target);
      const res = registerUser(fd);
      if(!res.ok) alert(res.msg);
      else { alert('Inscription r√©ussie'); fermerModal(); }
    });
  } else if(mode === 'paymentSimule'){
    modal.innerHTML = `
      <h3>Paiement par carte ‚Äî Simulation</h3>
      <p class="muted-note">Ceci est une simulation. En production, int√©grez Stripe ou un PSP s√©curis√©.</p>
      <label>Num√©ro de carte</label><input id="sim_card_number" name="sim_card_number" type="text" placeholder="4242 4242 4242 4242" />
      <div style="display:flex; gap:8px">
        <div style="flex:1">
          <label>MM/AA</label><input id="sim_card_date" name="sim_card_date" type="text" placeholder="12/34" />
        </div>
        <div style="width:120px">
          <label>CVV</label><input id="sim_card_cvv" name="sim_card_cvv" type="text" placeholder="123" />
        </div>
      </div>
      <div class="actions">
        <button class="btn-primary" id="confirmCard">Payer (simul√©)</button>
        <button type="button" class="btn-ghost" id="cancelCard">Annuler</button>
      </div>
    `;
    backdrop.appendChild(modal);
    modalWrapper.appendChild(backdrop);
    setTimeout(()=> {
      const btn = document.getElementById('confirmCard');
      if(btn) btn.addEventListener('click', function(){
        fermerModal();
        document.getElementById('paymentStatus').value = 'paid_card_simule';
        submitOrder({ paymentProvider: 'card_simulated' });
      });
      const cancel = document.getElementById('cancelCard');
      if(cancel) cancel.addEventListener('click', fermerModal);
    }, 30);
  } else {
    modal.innerHTML = `<div><p>Mode modal inconnu</p><div class="actions"><button onclick="fermerModal()">Fermer</button></div></div>`;
    backdrop.appendChild(modal);
    modalWrapper.appendChild(backdrop);
  }
}

function fermerModal(){
  modalWrapper.innerHTML = '';
  modalWrapper.setAttribute('aria-hidden', 'true');
}

/* ===========================
   Quick access & helpers
   =========================== */
function afficherDetailsById(id){ afficherDetails(id); }

/* ===========================
   Quick attach of global handlers
   =========================== */
function attachGlobalHandlers(){
  // Nav buttons
  document.getElementById('navAccueil').addEventListener('click', afficherAccueil);
  document.getElementById('navBoutique').addEventListener('click', function(){ renderProduits(); afficherBoutique(); });
  document.getElementById('navPanier').addEventListener('click', afficherPanier);

  // grid product actions (delegate)
  document.getElementById('gridProduits').addEventListener('click', function(e){
    const btn = e.target.closest('button');
    if(!btn) return;
    const action = btn.getAttribute('data-action');
    const id = btn.getAttribute('data-id');
    if(action === 'voir') afficherDetails(id);
    if(action === 'ajouter') ajouterAuPanier(id, 1);
  });

  // panier buttons
  document.getElementById('viderPanierBtn').addEventListener('click', viderPanier);
  document.getElementById('commanderPanierBtn').addEventListener('click', commanderPanier);

  // order form
  document.getElementById('orderForm').addEventListener('submit', handleOrderFormSubmit);
  document.getElementById('btnCancelOrder').addEventListener('click', function(){ afficherBoutique(); });

  // auth modals
  document.getElementById('openLoginBtn').addEventListener('click', function(){ ouvrirModal('login'); });
  document.getElementById('openRegisterBtn').addEventListener('click', function(){ ouvrirModal('register'); });
  document.getElementById('logoutBtn').addEventListener('click', deconnexion);

  // expose some functions
  window.afficherAccueil = afficherAccueil;
  window.afficherBoutique = afficherBoutique;
  window.afficherPanier = afficherPanier;
  window.afficherDetails = afficherDetailsById;
  window.ouvrirModal = ouvrirModal;
  window.fermerModal = fermerModal;
  window.viderPanier = viderPanier;
  window.ajouterPanierParBtn = ajouterPanierParBtn;
  window.ajouterAuPanier = ajouterAuPanier;
  window.commanderPanier = commanderPanier;
  window.ouvrirFormulairePour = ouvrirFormulairePour;
  window.deconnexion = deconnexion;
}

/* End of script */
</script>
</body>
</html>
